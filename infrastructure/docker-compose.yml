 #!/usr/bin/env sh
version: '3.8'

services:
  communication:
    build:
      context: ../communication
      dockerfile: Dockerfile
    environment:
      DATABASE_URI: ${MONGO_URI}
      RABBITMQ_EXCHANGE_NAME: ${RABBITMQ_EXCHANGE_NAME}
      RABBITMQ_QUEUE_NAME: ${RABBITMQ_QUEUE_NAME}
      AMQP_USERNAME: ${AMQP_USERNAME}
      AMQP_PASSWORD: ${AMQP_PASSWORD}
      URL: ${AMQP_URL}
      MAILGUN_API_KEY: ${MAILGUN_API_KEY}
      MAILGUN_DOMAIN: ${MAILGUN_DOMAIN}
      MAILGUN_EMAIL: ${MAILGUN_EMAIL}
    ports:
      - 4001:4000
      - 9229:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  infra:
    build:
      context: ../infra
      dockerfile: Dockerfile
    environment:
      MONGODB_CONNECTION: ${MONGO_URI}
      AMQP_URL: ${AMQP_URL}
      AMQP_USERNAME: ${AMQP_USERNAME}
      AMQP_PASSWORD: ${AMQP_PASSWORD}
      RABBITMQ_EXCHANGE_NAME: ${RABBITMQ_EXCHANGE_NAME}
      RABBITMQ_QUEUE_NAME: ${RABBITMQ_QUEUE_NAME}
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
      AUTH0_ISSUER_BASE_URL: ${AUTH0_ISSUER_BASE_URL}
    ports:
      - 4002:4000
      - 9228:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  inventory:
    build:
      context: ../inventory
      dockerfile: Dockerfile
    environment:
      MONGO_URI: ${MONGO_URI}
      DB_NAME: ${DB_NAME}
    ports:
      - 4003:4000
      - 9227:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  orders:
    build:
      context: ../orders
      dockerfile: Dockerfile
    environment:
      MONGODB_CONNECTION: ${MONGO_URI}
      AMQP_HOST: ${AMQP_HOST}
      AMQP_PORT: ${AMQP_PORT}
      AMQP_USERNAME: ${RABBITMQ_DEFAULT_USER}
      AMQP_PASSWORD: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_EXCHANGE_NAME: ${RABBITMQ_EXCHANGE_NAME}
      RABBITMQ_QUEUE_NAME: ${RABBITMQ_QUEUE_NAME}
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
      AUTH0_ISSUER_BASE_URL: ${AUTH0_ISSUER_BASE_URL}
    ports:
      - 4004:4000
      - 9226:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  website:
    build:
      context: ../website
      dockerfile: Dockerfile
    environment:
      MONGODB_CONNECTION: ${MONGO_URI}
      AMQP_HOST: ${AMQP_HOST}
      AMQP_PORT: ${AMQP_PORT}
      AMQP_USERNAME: ${RABBITMQ_DEFAULT_USER}
      AMQP_PASSWORD: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_EXCHANGE_NAME: ${RABBITMQ_EXCHANGE_NAME}
      RABBITMQ_QUEUE_NAME: ${RABBITMQ_QUEUE_NAME}
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
      AUTH0_ISSUER_BASE_URL: ${AUTH0_ISSUER_BASE_URL}
    ports:
      - 4005:5173
      - 9225:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  workers:
    build:
      context: ../workers
      dockerfile: Dockerfile
    environment:
      MONGODB_CONNECTION: ${MONGO_URI}
      AMQP_HOST: ${AMQP_HOST}
      AMQP_PORT: ${AMQP_PORT}
      AMQP_USERNAME: ${RABBITMQ_DEFAULT_USER}
      AMQP_PASSWORD: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_EXCHANGE_NAME: ${RABBITMQ_EXCHANGE_NAME}
      RABBITMQ_QUEUE_NAME: ${RABBITMQ_QUEUE_NAME}
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
      AUTH0_ISSUER_BASE_URL: ${AUTH0_ISSUER_BASE_URL}
    ports:
      - 4006:4000
      - 9224:9229
    networks:
      - nesjs-network
    depends_on:
      - mongodb
    restart: unless-stopped

  mongodb:
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    ports:
      - "${MONGODB_PORT}:27017"
    volumes:
      - ./database:/data/db
    networks:
      - nesjs-network
    restart: always

  rabbitmq:
    image: rabbitmq:3.8-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${AMQP_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${AMQP_PASSWORD}
    ports:
      - "${AMQP_PORT}:5672"
    volumes:
      - ./rabbitmq/data/:/var/lib/rabbitmq
      - ./rabbitmq/log/:/var/log/rabbitmq
    networks:
      - nesjs-network
    restart: always

networks:
  nesjs-network:
    driver: bridge
